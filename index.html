<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-K7QK3K5D59"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-K7QK3K5D59');
  </script>
  <title>مشغل الفيديو المتطور</title>
  <link rel="icon" type="image/png" href="https://firebasestorage.googleapis.com/v0/b/alnasseri-70c15.appspot.com/o/fs%2F1000032030.png?alt=media&token=0eef3c8f-6eba-4af6-bd33-da5a6870418b">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #2CAF1D;
      --secondary-color: #179CDE;
      --accent-color: #FF6347;
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --text-color: #333333;
      --border-color: #e0e0e0;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
    }

    .dark-mode {
      --primary-color: #1a8c0f;
      --secondary-color: #0d6b99;
      --accent-color: #cc4c38;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #f0f0f0;
      --border-color: #333333;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: all 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header Styles */
    header {
      background-color: var(--card-bg);
      box-shadow: var(--shadow);
      padding: 15px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      height: 50px;
      transition: transform 0.3s ease;
    }

    .logo:hover {
      transform: scale(1.05);
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background-color: #ccc;
      border-radius: 12px;
      transition: background-color 0.3s;
    }

    .toggle-switch.active {
      background-color: var(--primary-color);
    }

    .toggle-slider {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 50%;
      top: 2px;
      right: 2px;
      transition: all 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
      right: 28px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 30px;
      padding: 30px 0;
    }

    /* Player Section */
    .player-section {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .player-container {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 Aspect Ratio */
      background-color: #000;
    }

    #video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      outline: none;
    }

    /* Controls Section */
    .controls-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .url-input-container {
      position: relative;
    }

    #videoUrl {
      width: 100%;
      padding: 15px 20px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--card-bg);
      color: var(--text-color);
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }

    #videoUrl:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(44, 175, 29, 0.2);
    }

    .control-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-family: 'Cairo', sans-serif;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #239e16;
      transform: translateY(-2px);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #1288c7;
      transform: translateY(-2px);
    }

    .btn-accent {
      background-color: var(--accent-color);
      color: white;
    }

    .btn-accent:hover {
      background-color: #e55a3f;
      transform: translateY(-2px);
    }

    .btn-icon {
      width: 20px;
      height: 20px;
    }

    /* Headers Section */
    .headers-section {
      background-color: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .section-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title-icon {
      width: 24px;
      height: 24px;
    }

    .headers-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .header-item {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .header-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background-color: var(--card-bg);
      color: var(--text-color);
      font-family: 'Cairo', sans-serif;
    }

    .header-actions {
      display: flex;
      gap: 5px;
    }

    .header-btn {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .header-btn:hover {
      transform: scale(1.1);
    }

    .add-header-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .add-header-btn:hover {
      background-color: #239e16;
    }

    /* Status Bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-icon {
      width: 18px;
      height: 18px;
    }

    .status-text {
      font-size: 14px;
    }

    .status-value {
      font-weight: bold;
      color: var(--primary-color);
    }

    /* Modals */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
      transform: translateY(20px);
      transition: all 0.3s ease;
    }

    .modal.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      color: var(--primary-color);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
    }

    .quality-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--card-bg);
      color: var(--text-color);
      font-family: 'Cairo', sans-serif;
      margin-bottom: 20px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .control-buttons {
        grid-template-columns: 1fr;
      }
      
      .header-item {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header-actions {
        justify-content: flex-end;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease forwards;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-content">
      <img src="https://i.imghippo.com/files/kfXw7179kyo.png" alt="Logo" class="logo">
      <div class="theme-toggle" id="themeToggle">
        <div class="toggle-switch">
          <div class="toggle-slider"></div>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </div>
    </div>
  </header>

  <main class="container main-content">
    <section class="player-section">
      <div class="player-container">
        <video id="video" controls autoplay playsinline></video>
      </div>
    </section>

    <section class="controls-section">
      <div class="url-input-container">
        <input type="text" id="videoUrl" placeholder="أدخل رابط الفيديو (HLS/m3u8)" dir="ltr">
      </div>
      
      <div class="control-buttons">
        <button class="btn btn-primary" onclick="playVideo()">
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          تشغيل الفيديو
        </button>
        <button class="btn btn-secondary" onclick="showQualityDialog()">
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
          </svg>
          تغيير الجودة
        </button>
        <button class="btn btn-accent" onclick="clearVideo()">
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
          مسح الفيديو
        </button>
      </div>
    </section>

    <section class="headers-section">
      <h3 class="section-title">
        <svg class="section-title-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
        رؤوس HTTP مخصصة
      </h3>
      
      <div class="headers-list" id="headersList">
        <!-- Headers will be added here dynamically -->
      </div>
      
      <button class="add-header-btn" onclick="addHeaderField()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        إضافة رأس جديد
      </button>
    </section>

    <div class="status-bar">
      <div class="status-item">
        <svg class="status-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        <span class="status-text">المشغل:</span>
        <span class="status-value" id="currentPlayer">hls.js</span>
      </div>
      <div class="status-item">
        <svg class="status-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
        </svg>
        <span class="status-text">الحالة:</span>
        <span class="status-value" id="playerStatus">جاهز</span>
      </div>
    </div>
  </main>

  <!-- Quality Modal -->
  <div class="modal" id="qualityModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">اختر جودة البث</h3>
        <button class="modal-close" onclick="hideQualityDialog()">&times;</button>
      </div>
      <select class="quality-select" id="quality">
        <option value="auto">تلقائي (افتراضي)</option>
      </select>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="applyQuality()">تطبيق</button>
        <button class="btn btn-accent" onclick="hideQualityDialog()">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Library -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  
  <script>
    let hls;
    let video = document.getElementById('video');
    let headers = [];
    let qualityLevels = [];

    // Initialize the app
    function init() {
      checkDarkModePreference();
      loadPlayerSettings();
      loadHeaders();
      setupEventListeners();
      
      // Add initial header field if none exists
      if (headers.length === 0) {
        addHeaderField();
      }
    }

    // Check user's dark mode preference
    function checkDarkModePreference() {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const darkMode = localStorage.getItem('darkMode');
      
      if (darkMode === 'enabled' || (darkMode === null && prefersDark)) {
        enableDarkMode();
        document.querySelector('.toggle-switch').classList.add('active');
      } else {
        disableDarkMode();
      }
    }

    // Enable dark mode
    function enableDarkMode() {
      document.body.classList.add('dark-mode');
      localStorage.setItem('darkMode', 'enabled');
    }

    // Disable dark mode
    function disableDarkMode() {
      document.body.classList.remove('dark-mode');
      localStorage.setItem('darkMode', 'disabled');
    }

    // Load player settings from localStorage
    function loadPlayerSettings() {
      const lastUrl = localStorage.getItem('lastVideoUrl');
      if (lastUrl) {
        document.getElementById('videoUrl').value = lastUrl;
      }
      
      updatePlayerStatus('جاهز');
    }

    // Load headers from localStorage
    function loadHeaders() {
      const savedHeaders = localStorage.getItem('customHeaders');
      if (savedHeaders) {
        headers = JSON.parse(savedHeaders);
        renderHeaders();
      }
    }

    // Save headers to localStorage
    function saveHeaders() {
      localStorage.setItem('customHeaders', JSON.stringify(headers));
    }

    // Setup event listeners
    function setupEventListeners() {
      // Theme toggle
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
        if (localStorage.getItem('darkMode') === null) {
          if (e.matches) {
            enableDarkMode();
            document.querySelector('.toggle-switch').classList.add('active');
          } else {
            disableDarkMode();
            document.querySelector('.toggle-switch').classList.remove('active');
          }
        }
      });
    }

    // Toggle theme between light and dark
    function toggleTheme() {
      const toggleSwitch = document.querySelector('.toggle-switch');
      toggleSwitch.classList.toggle('active');
      
      if (document.body.classList.contains('dark-mode')) {
        disableDarkMode();
      } else {
        enableDarkMode();
      }
    }

    // Update player status
    function updatePlayerStatus(status) {
      document.getElementById('playerStatus').textContent = status;
    }

    // Add a new header field
    function addHeaderField(header = { name: '', value: '' }) {
      headers.push(header);
      renderHeaders();
    }

    // Remove a header field
    function removeHeaderField(index) {
      headers.splice(index, 1);
      renderHeaders();
      saveHeaders();
    }

    // Update a header field
    function updateHeaderField(index, field, value) {
      headers[index][field] = value;
      saveHeaders();
    }

    // Render all headers
    function renderHeaders() {
      const headersList = document.getElementById('headersList');
      headersList.innerHTML = '';
      
      headers.forEach((header, index) => {
        const headerItem = document.createElement('div');
        headerItem.className = 'header-item';
        headerItem.innerHTML = `
          <input type="text" class="header-input" placeholder="اسم الرأس (مثال: User-Agent)" 
                 value="${header.name}" 
                 onchange="updateHeaderField(${index}, 'name', this.value)">
          <input type="text" class="header-input" placeholder="قيمة الرأس" 
                 value="${header.value}" 
                 onchange="updateHeaderField(${index}, 'value', this.value)">
          <div class="header-actions">
            <div class="header-btn" style="background-color: var(--success-color);" title="تمكين">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
            </div>
            <div class="header-btn" style="background-color: var(--error-color);" title="حذف" onclick="removeHeaderField(${index})">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </div>
          </div>
        `;
        headersList.appendChild(headerItem);
      });
    }

    // Show quality dialog
    function showQualityDialog() {
      if (!hls || !qualityLevels.length) {
        alert('لا توجد خيارات جودة متاحة حالياً. يرجى تشغيل الفيديو أولاً.');
        return;
      }
      
      const qualitySelect = document.getElementById('quality');
      
      // Remove all options except the first one (Auto)
      while (qualitySelect.options.length > 1) {
        qualitySelect.remove(1);
      }
      
      // Add available quality levels
      qualityLevels.forEach((level, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${level.height}p (${Math.round(level.bitrate / 1000)} كيلوبت/ثانية)`;
        qualitySelect.appendChild(option);
      });
      
      // Show the modal
      document.getElementById('qualityModal').classList.add('active');
    }

    // Hide quality dialog
    function hideQualityDialog() {
      document.getElementById('qualityModal').classList.remove('active');
    }

    // Apply selected quality
    function applyQuality() {
      const selectedQuality = document.getElementById('quality').value;
      
      if (hls) {
        if (selectedQuality === 'auto') {
          hls.currentLevel = -1;
        } else {
          hls.currentLevel = parseInt(selectedQuality);
        }
      }
      
      hideQualityDialog();
    }

    // Play video with HLS.js
    function playVideo() {
      const streamUrl = document.getElementById('videoUrl').value.trim();
      
      if (!streamUrl) {
        alert('الرجاء إدخال رابط الفيديو');
        return;
      }
      
      // Save the URL for later use
      localStorage.setItem('lastVideoUrl', streamUrl);
      updatePlayerStatus('جاري التحميل...');
      
      // Destroy previous HLS instance if exists
      if (hls) {
        hls.destroy();
      }
      
      // Initialize HLS.js
      if (Hls.isSupported()) {
        hls = new Hls({
          maxMaxBufferLength: 60,
          maxBufferSize: 60 * 1000 * 1000,
          maxBufferLength: 30,
          lowLatencyMode: false,
          enableWorker: true,
          startLevel: -1,
          abrEwmaDefaultEstimate: 500000,
          abrBandWidthFactor: 0.95,
          abrBandWidthUpFactor: 0.7,
          abrMaxWithRealBitrate: true,
          xhrSetup: function(xhr, url) {
            // Apply custom headers
            headers.forEach(header => {
              if (header.name && header.value) {
                xhr.setRequestHeader(header.name, header.value);
              }
            });
          }
        });
        
        hls.loadSource(streamUrl);
        hls.attachMedia(video);
        
        hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
          updatePlayerStatus('جاري التشغيل');
          qualityLevels = data.levels;
        });
        
        hls.on(Hls.Events.ERROR, function(event, data) {
          if (data.fatal) {
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                updatePlayerStatus('خطأ في الشبكة');
                alert('حدث خطأ في الشبكة. يرجى التحقق من الاتصال أو الرابط.');
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                updatePlayerStatus('خطأ في الوسائط');
                alert('حدث خطأ في تشغيل الفيديو. يرجى التحقق من الرابط.');
                break;
              default:
                updatePlayerStatus('خطأ غير معروف');
                alert('حدث خطأ غير معروف أثناء تشغيل الفيديو.');
                break;
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Fallback for Safari
        video.src = streamUrl;
        video.addEventListener('loadedmetadata', function() {
          updatePlayerStatus('جاري التشغيل');
          video.play().catch(e => {
            updatePlayerStatus('خطأ في التشغيل');
            console.error('Error playing video:', e);
          });
        });
      } else {
        alert('المتصفح لا يدعم تشغيل هذا النوع من الفيديو');
        updatePlayerStatus('غير مدعوم');
      }
    }

    // Clear video and reset player
    function clearVideo() {
      if (hls) {
        hls.destroy();
        hls = null;
      }
      
      video.src = '';
      document.getElementById('videoUrl').value = '';
      localStorage.removeItem('lastVideoUrl');
      updatePlayerStatus('جاهز');
    }

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
