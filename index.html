<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>remo TV ريمو تيفي</title>
  <style>
    /* ... (ابقى على أنماط CSS السابقة كما هي) ... */
  </style>
</head>
<body>

  <header>
    <div class="logo-container">
      <img src="https://firebasestorage.googleapis.com/v0/b/alnasseri-70c15.appspot.com/o/fs%2F1000142637.png?alt=media&token=a6caf096-876f-49e1-8368-2a622f847e6d" alt="remo TV Logo">
    </div>
  </header>

  <div class="player-container">
    <video id="video" controls></video>
    <div class="quality-selector" id="qualityContainer" style="display: none;">
      <label for="quality">اختر الجودة:</label>
      <select id="quality"></select>
    </div>

    <div class="config-panel">
      <h3>إعدادات الاتصال</h3>
      <div class="config-input">
        <label for="streamUrl">رابط البث:</label>
        <input type="text" id="streamUrl" placeholder="https://example.com/stream.m3u8">
      </div>
      <!-- باقي حقول الإدخال -->
      <button id="loadStream" class="btn">تشغيل البث</button>
      <div id="status" class="status" style="display: none;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const video = document.getElementById('video');
    const streamUrlInput = document.getElementById('streamUrl');
    const loadStreamBtn = document.getElementById('loadStream');
    const qualityContainer = document.getElementById('qualityContainer');
    const qualitySelect = document.getElementById('quality');
    const statusDiv = document.getElementById('status');

    let hls = null;

    function showStatus(message, isError = false) {
      statusDiv.textContent = message;
      statusDiv.className = isError ? 'status error' : 'status success';
      statusDiv.style.display = 'block';
    }

    function loadStream() {
      if (hls) {
        hls.destroy();
      }

      const streamUrl = streamUrlInput.value.trim();
      if (!streamUrl) {
        showStatus('الرجاء إدخال رابط البث', true);
        return;
      }

      // إعداد CORS proxy لتفادي مشاكل CORS
      const corsProxy = 'https://cors-anywhere.herokuapp.com/';
      const useProxy = !streamUrl.includes('mux.dev'); // لا تستخدم البروكسي مع الروابط التجريبية

      const config = {
        xhrSetup: function(xhr, url) {
          if (useProxy) {
            xhr.open('GET', corsProxy + url, true);
          }
          xhr.withCredentials = true;
        },
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 30
      };

      if (Hls.isSupported()) {
        hls = new Hls(config);
        hls.loadSource(useProxy ? corsProxy + streamUrl : streamUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          qualityContainer.style.display = 'block';
          qualitySelect.innerHTML = '';

          const autoOption = document.createElement('option');
          autoOption.value = -1;
          autoOption.text = 'تلقائي';
          autoOption.selected = true;
          qualitySelect.appendChild(autoOption);

          hls.levels.forEach((level, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.text = `${level.height}p (${Math.round(level.bitrate/1000)}kbps)`;
            qualitySelect.appendChild(option);
          });

          showStatus('جاري التشغيل...');
          video.play().catch(e => {
            showStatus('يتطلب التفاعل مع الصفحة لتشغيل الفيديو', true);
          });
        });

        hls.on(Hls.Events.ERROR, function(event, data) {
          let errorMsg = 'خطأ في تحميل البث';
          if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
            errorMsg = 'مشكلة في الشبكة أو الرابط غير صحيح';
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
            errorMsg = 'مشكلة في تنسيق الفيديو';
          }
          
          if (data.fatal) {
            showStatus(`${errorMsg}: ${data.details}`, true);
            switch(data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR:
                hls.startLoad();
                break;
              case Hls.ErrorTypes.MEDIA_ERROR:
                hls.recoverMediaError();
                break;
              default:
                loadStream();
                break;
            }
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = streamUrl;
        video.addEventListener('loadedmetadata', function() {
          showStatus('جاري التشغيل (وضع Safari)...');
          video.play().catch(e => {
            showStatus('يتطلب التفاعل مع الصفحة لتشغيل الفيديو', true);
          });
        });
      } else {
        showStatus('المتصفح لا يدعم تشغيل هذا النوع من البث', true);
      }
    }

    loadStreamBtn.addEventListener('click', loadStream);

    // مثال لتحميل رابط افتراضي
    streamUrlInput.value = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
    loadStream();
  </script>
</body>
</html>
